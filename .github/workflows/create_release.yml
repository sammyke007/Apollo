name: build release
run-name: Apollo build & release

on:
  workflow_dispatch:
    inputs:
      apollo_ipa_url:
        description: 'Apollo .ipa URL'
        required: false
        default: 'https://files.catbox.moe/o2lue0.ipa'

env:
  PYTHON_VERSION: '3.13'
  APOLLO_IPA_URL: ${{ inputs.apollo_ipa_url || 'https://files.catbox.moe/o2lue0.ipa' }}
  PYZULE_RW_URL: 'https://github.com/asdfzxcvbn/pyzule-rw/archive/main.zip'

jobs:
  build-apollo-ipa:
    runs-on: macos-latest

    steps:
      - name: Check out repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Setup Python
        uses: actions/setup-python@v4
        with:
          python-version: ${{ env.PYTHON_VERSION }}

      - name: Install Python dependencies
        run: |
          python -m pip install --upgrade pip
          pip install requests
          pip install --force-reinstall "${{ env.PYZULE_RW_URL }}"

      - name: Install ldid
        run: brew install ldid

      # ------------------------------------------------------------
      # Bepaal nieuwste ImprovedCustomApi release
      # ------------------------------------------------------------
      - name: Determine latest ImprovedCustomApi release
        id: get-release
        run: |
          LATEST_TAG=$(git ls-remote --tags https://github.com/JeffreyCA/Apollo-ImprovedCustomApi.git \
            | awk -F/ '{print $3}' \
            | grep '^v' \
            | sort -V \
            | tail -n 1)

          if [ -z "$LATEST_TAG" ]; then
            echo "âŒ Could not determine latest tag"
            exit 1
          fi

          VERSION="${LATEST_TAG#v}"
          DEB_NAME="ca.jeffrey.apollo-improvedcustomapi_${VERSION}_iphoneos-arm64_rootless.deb"
          DEB_URL="https://github.com/JeffreyCA/Apollo-ImprovedCustomApi/releases/download/${LATEST_TAG}/${DEB_NAME}"

          echo "RELEASE_TAG=$LATEST_TAG" >> "$GITHUB_OUTPUT"
          echo "DEB_URL=$DEB_URL" >> "$GITHUB_OUTPUT"

      # ------------------------------------------------------------
      # ðŸ”¹ Upstream changelog ophalen (curl + python, ZONDER heredoc)
      # ------------------------------------------------------------
      - name: Fetch ImprovedCustomApi changelog
        id: upstream
        run: |
          cat > fetch_changelog.py <<'PYEOF'
      import requests, os
      
      tag = os.environ["RELEASE_TAG"]
      url = f"https://api.github.com/repos/JeffreyCA/Apollo-ImprovedCustomApi/releases/tags/{tag}"
      
      r = requests.get(url, timeout=10)
      r.raise_for_status()
      
      print(r.json().get("body", "").strip())
      PYEOF
      
          python fetch_changelog.py > upstream_notes.txt
      
          echo "UPSTREAM_NOTES<<EOF" >> "$GITHUB_OUTPUT"
          cat upstream_notes.txt >> "$GITHUB_OUTPUT"
          echo "EOF" >> "$GITHUB_OUTPUT"
        env:
          RELEASE_TAG: ${{ steps.get-release.outputs.RELEASE_TAG }}

      # ------------------------------------------------------------
      # Download IPA + DEB
      # ------------------------------------------------------------
      - name: Download Apollo IPA and ImprovedCustomApi DEB
        id: download
        run: |
          curl -L "$APOLLO_IPA_URL" -o Apollo.ipa
          curl -L "${{ steps.get-release.outputs.DEB_URL }}" -o improvedcustomapi.deb

          APOLLO_VERSION=$(unzip -p Apollo.ipa 'Payload/*.app/Info.plist' \
            | grep -A1 CFBundleShortVersionString \
            | grep string \
            | sed -E 's/.*<string>([^<]+)<\/string>.*/\1/' \
            | tr -d '[:space:]')

          ICA_VERSION="${{ steps.get-release.outputs.RELEASE_TAG }}"
          ICA_VERSION="${ICA_VERSION#v}"

          echo "APOLLO_VERSION=$APOLLO_VERSION" >> "$GITHUB_OUTPUT"
          echo "ICA_VERSION=$ICA_VERSION" >> "$GITHUB_OUTPUT"
          echo "OUTPUT_NAME=Apollo-${APOLLO_VERSION}_ImprovedCustomApi-${ICA_VERSION}" >> "$GITHUB_OUTPUT"

      # ------------------------------------------------------------
      # Build IPA
      # ------------------------------------------------------------
      - name: Build modified IPA
        run: |
          mkdir -p build/Payload
          cd build

          cyan -i ../Apollo.ipa \
               -o Payload/Apollo.app \
               -f ../improvedcustomapi.deb \
               --fakesign

          zip -6 -rq "${{ steps.download.outputs.OUTPUT_NAME }}.ipa" Payload -x "*/.*"

          vtool -set-build-version ios 15.0 19.0 -replace \
            -output Payload/Apollo.app/Apollo Payload/Apollo.app/Apollo

          ldid -S -M Payload/Apollo.app/Apollo

          zip -6 -rq "GLASS_${{ steps.download.outputs.OUTPUT_NAME }}.ipa" Payload -x "*/.*"

      # ------------------------------------------------------------
      # Release notes
      # ------------------------------------------------------------
      - name: Generate release notes
        run: |
          {
            echo "## Apollo build"
            echo "- Apollo version: \`v${{ steps.download.outputs.APOLLO_VERSION }}\`"
            echo "- ImprovedCustomApi version: \`v${{ steps.download.outputs.ICA_VERSION }}\`"
            echo ""
            echo "## ImprovedCustomApi changelog"
            echo "${{ steps.upstream.outputs.UPSTREAM_NOTES }}"
            echo ""
            echo "## Known Issues"
            echo "- Apollo Ultra features may cause crashes"
            echo "- Imgur multi-image upload"
          } > RELEASE_NOTES.md

      # ------------------------------------------------------------
      # Create GitHub release
      # ------------------------------------------------------------
      - name: Create GitHub release
        uses: softprops/action-gh-release@v2
        with:
          tag_name: v${{ steps.download.outputs.APOLLO_VERSION }}_${{ steps.download.outputs.ICA_VERSION }}
          name: Apollo v${{ steps.download.outputs.APOLLO_VERSION }} with ImprovedCustomApi v${{ steps.download.outputs.ICA_VERSION }}
          body_path: RELEASE_NOTES.md
          files: |
            build/${{ steps.download.outputs.OUTPUT_NAME }}.ipa
            build/GLASS_${{ steps.download.outputs.OUTPUT_NAME }}.ipa
