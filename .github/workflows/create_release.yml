name: build release

on:
  workflow_call:
  workflow_dispatch:
    inputs:
      apollo_ipa_url:
        description: 'Apollo .ipa URL'
        required: false
        default: 'https://files.catbox.moe/o2lue0.ipa'
      catbox_upload:
        description: 'Upload to Catbox.moe'
        type: boolean
        default: false

env:
  PYTHON_VERSION: '3.13'
  APOLLO_IPA_URL: ${{ inputs.apollo_ipa_url || 'https://files.catbox.moe/o2lue0.ipa' }}
  CATBOX_UPLOAD: ${{ inputs.catbox_upload }}
  PYZULE_RW_URL: "https://github.com/asdfzxcvbn/pyzule-rw/archive/main.zip"

jobs:
  build-apollo-ipa:
    runs-on: macos-latest
    defaults:
      run:
        shell: bash

    steps:
      - name: Check out repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Setup python
        uses: actions/setup-python@v4
        with:
          python-version: ${{ env.PYTHON_VERSION }}

      - name: Install python dependencies
        run: |
          python -m pip install --upgrade pip
          pip install requests
          pip install --force-reinstall "${{ env.PYZULE_RW_URL }}"

      - name: Install ldid
        run: brew install ldid

      # ------------------------------------------------------------
      # ðŸ”¥ Bepaal laatste ImprovedCustomApi release + changelog
      # ------------------------------------------------------------
      - name: Determine latest ImprovedCustomApi release
        id: get-release
        run: |
          LATEST_TAG=$(git ls-remote --tags https://github.com/JeffreyCA/Apollo-ImprovedCustomApi.git \
            | awk -F/ '{print $3}' \
            | grep '^v' \
            | sort -V \
            | tail -n 1)

          if [ -z "$LATEST_TAG" ]; then
            echo "Error: Could not determine latest tag"
            exit 1
          fi

          VERSION="${LATEST_TAG#v}"
          DEB_NAME="ca.jeffrey.apollo-improvedcustomapi_${VERSION}_iphoneos-arm64_rootless.deb"
          DEB_URL="https://github.com/JeffreyCA/Apollo-ImprovedCustomApi/releases/download/${LATEST_TAG}/${DEB_NAME}"

          # âœ… Correct JSON parsing via Python
          UPSTREAM_NOTES=$(python - <<EOF
import requests
url = "https://api.github.com/repos/JeffreyCA/Apollo-ImprovedCustomApi/releases/tags/${LATEST_TAG}"
r = requests.get(url, timeout=10)
r.raise_for_status()
print(r.json().get("body", "").strip())
EOF
          )

          echo "RELEASE_TAG=$LATEST_TAG" >> "$GITHUB_OUTPUT"
          echo "DEB_URL=$DEB_URL" >> "$GITHUB_OUTPUT"

          echo "UPSTREAM_NOTES<<EOF" >> "$GITHUB_OUTPUT"
          echo "$UPSTREAM_NOTES" >> "$GITHUB_OUTPUT"
          echo "EOF" >> "$GITHUB_OUTPUT"

      - name: Download apollo .ipa and improvedcustomapi .deb
        id: download-files
        env:
          DEB_URL: ${{ steps.get-release.outputs.DEB_URL }}
          RELEASE_TAG: ${{ steps.get-release.outputs.RELEASE_TAG }}
        run: |
          curl -L "$APOLLO_IPA_URL" -o Apollo.ipa

          APOLLO_VERSION=$(unzip -p Apollo.ipa 'Payload/*.app/Info.plist' \
            | grep -A1 CFBundleShortVersionString \
            | grep string \
            | sed -E 's/.*<string>([^<]+)<\/string>.*/\1/' \
            | tr -d '[:space:]')

          curl -L "$DEB_URL" -o improvedcustomapi.deb

          ICA_VERSION="${RELEASE_TAG#v}"

          echo "APOLLO_VERSION=$APOLLO_VERSION" >> "$GITHUB_OUTPUT"
          echo "ICA_VERSION=$ICA_VERSION" >> "$GITHUB_OUTPUT"
          echo "OUTPUT_NAME=Apollo-${APOLLO_VERSION}_ImprovedCustomApi-${ICA_VERSION}" >> "$GITHUB_OUTPUT"

      - name: Setup build folders
        env:
          OUTPUT_NAME: ${{ steps.download-files.outputs.OUTPUT_NAME }}
        run: |
          mkdir -p "${OUTPUT_NAME}/Payload"
          mkdir -p "NO-EXTENSIONS_${OUTPUT_NAME}/Payload"

      - name: Build modified .ipa
        env:
          OUTPUT_NAME: ${{ steps.download-files.outputs.OUTPUT_NAME }}
        working-directory: ${{ steps.download-files.outputs.OUTPUT_NAME }}
        run: |
          cyan -i "${GITHUB_WORKSPACE}/Apollo.ipa" \
               -o "Payload/Apollo.app" \
               -f "${GITHUB_WORKSPACE}/improvedcustomapi.deb" \
               --fakesign

          zip -6 -rq "${OUTPUT_NAME}.ipa" Payload -x "*/.*"

          vtool -set-build-version ios 15.0 19.0 -replace \
            -output Payload/Apollo.app/Apollo Payload/Apollo.app/Apollo

          ldid -S -M Payload/Apollo.app/Apollo

          zip -6 -rq "GLASS_${OUTPUT_NAME}.ipa" Payload -x "*/.*"

      - name: Build no extension modified .ipa
        env:
          OUTPUT_NAME: ${{ steps.download-files.outputs.OUTPUT_NAME }}
        working-directory: NO-EXTENSIONS_${{ steps.download-files.outputs.OUTPUT_NAME }}
        run: |
          cyan -i "${GITHUB_WORKSPACE}/Apollo.ipa" \
               -o "Payload/Apollo.app" \
               -f "${GITHUB_WORKSPACE}/improvedcustomapi.deb" \
               --fakesign -e

          zip -6 -rq "NO-EXTENSIONS_${OUTPUT_NAME}.ipa" Payload -x "*/.*"

          vtool -set-build-version ios 15.0 19.0 -replace \
            -output Payload/Apollo.app/Apollo Payload/Apollo.app/Apollo

          ldid -S -M Payload/Apollo.app/Apollo

          zip -6 -rq "NO-EXTENSIONS_GLASS_${OUTPUT_NAME}.ipa" Payload -x "*/.*"

      - name: Generate release notes
        env:
          APOLLO_VERSION: ${{ steps.download-files.outputs.APOLLO_VERSION }}
          ICA_VERSION: ${{ steps.download-files.outputs.ICA_VERSION }}
          UPSTREAM_NOTES: ${{ steps.get-release.outputs.UPSTREAM_NOTES }}
        run: |
          {
            echo "## Apollo build"
            echo "- Apollo version: \`v${APOLLO_VERSION}\`"
            echo "- ImprovedCustomApi version: \`v${ICA_VERSION}\`"
            echo ""

            echo "## ImprovedCustomApi changelog"
            if [ -n "$UPSTREAM_NOTES" ]; then
              echo "$UPSTREAM_NOTES"
            else
              echo "_No upstream release notes found._"
            fi
            echo ""

            echo "## Known Issues"
            echo "- Apollo Ultra features may cause app crashes"
            echo "- Imgur multi-image upload"
          } > RELEASE_NOTES.md

      - name: Create release
        uses: softprops/action-gh-release@v2
        with:
          tag_name: v${{ steps.download-files.outputs.APOLLO_VERSION }}_${{ steps.download-files.outputs.ICA_VERSION }}
          name: Apollo v${{ steps.download-files.outputs.APOLLO_VERSION }} with ImprovedCustomApi v${{ steps.download-files.outputs.ICA_VERSION }}
          body_path: RELEASE_NOTES.md
          files: |
            ${{ steps.download-files.outputs.OUTPUT_NAME }}/${{ steps.download-files.outputs.OUTPUT_NAME }}.ipa
            ${{ steps.download-files.outputs.OUTPUT_NAME }}/GLASS_${{ steps.download-files.outputs.OUTPUT_NAME }}.ipa
            NO-EXTENSIONS_${{ steps.download-files.outputs.OUTPUT_NAME }}/NO-EXTENSIONS_${{ steps.download-files.outputs.OUTPUT_NAME }}.ipa
            NO-EXTENSIONS_${{ steps.download-files.outputs.OUTPUT_NAME }}/NO-EXTENSIONS_GLASS_${{ steps.download-files.outputs.OUTPUT_NAME }}.ipa

      - name: Job summary
        run: |
          echo "### âœ… Build completed successfully" >> $GITHUB_STEP_SUMMARY
          echo "- Apollo v${{ steps.download-files.outputs.APOLLO_VERSION }}" >> $GITHUB_STEP_SUMMARY
          echo "- ImprovedCustomApi v${{ steps.download-files.outputs.ICA_VERSION }}" >> $GITHUB_STEP_SUMMARY
